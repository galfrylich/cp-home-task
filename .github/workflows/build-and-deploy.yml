name: build-and-deploy

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ca-central-1
  EKS_CLUSTER: dev-eks
  NAMESPACE: email-services
  REGISTRY: docker.io
  SERVICE_1_IMAGE: galfrylich/service-1-api
  SERVICE_2_IMAGE: galfrylich/service-2-worker

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    
    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Generate ONE tag for everything
      - name: Generate image tag
        id: tag
        run: |
          TAG=$(git rev-parse --short HEAD)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # 3Ô∏è‚É£ Login to Docker Hub
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4Ô∏è‚É£ Build & push service-1
      - name: Build & push service-1
        run: |
          docker build -t $SERVICE_1_IMAGE:${{ steps.tag.outputs.tag }} service-1
          docker push $SERVICE_1_IMAGE:${{ steps.tag.outputs.tag }}

      # 5Ô∏è‚É£ Build & push service-2
      - name: Build & push service-2
        run: |
          docker build -t $SERVICE_2_IMAGE:${{ steps.tag.outputs.tag }} service-2
          docker push $SERVICE_2_IMAGE:${{ steps.tag.outputs.tag }}

      # 6Ô∏è‚É£ Configure AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 7Ô∏è‚É£ Configure kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name $EKS_CLUSTER \
            --region $AWS_REGION

      # 8Ô∏è‚É£ Deploy service-1 with Helm
      - name: Deploy service-1
        run: |
          helm upgrade --install service-1 service-1-chart \
            -n $NAMESPACE \
            --set image.repository=$SERVICE_1_IMAGE \
            --set image.tag=${{ steps.tag.outputs.tag }}

      # 9Ô∏è‚É£ Deploy service-2 with Helm
      - name: Deploy service-2
        run: |
          helm upgrade --install service-2 service-2-chart \
            -n $NAMESPACE \
            --set image.repository=$SERVICE_2_IMAGE \
            --set image.tag=${{ steps.tag.outputs.tag }}

      - name: ALB smoke test (health + send)
        shell: bash
        run: |
            set -e

            echo "üîé Fetching ALB DNS..."
            ALB_DNS=$(aws elbv2 describe-load-balancers \
            --region $AWS_REGION \
            --query "LoadBalancers[?contains(LoadBalancerName,'service-1')].DNSName | [0]" \
            --output text)

            if [ -z "$ALB_DNS" ] || [ "$ALB_DNS" = "None" ]; then
            echo "‚ùå ALB DNS not found"
            exit 1
            fi

            echo "‚úÖ ALB DNS: $ALB_DNS"

            echo "‚è≥ Waiting for targets to become healthy..."
            for i in {1..10}; do
            STATE=$(aws elbv2 describe-target-health \
                --target-group-arn $(aws elbv2 describe-target-groups \
                --region $AWS_REGION \
                --query "TargetGroups[?contains(TargetGroupName,'service-1')].TargetGroupArn | [0]" \
                --output text) \
                --region $AWS_REGION \
                --query "TargetHealthDescriptions[].TargetHealth.State" \
                --output text | tr '\t' '\n' | sort -u)

            echo "Target state(s): $STATE"

            if echo "$STATE" | grep -q healthy; then
                break
            fi

            sleep 15
            done

            if ! echo "$STATE" | grep -q healthy; then
            echo "‚ùå Targets are not healthy"
            exit 1
            fi

            echo "ü©∫ Health check..."
            curl --fail --retry 5 --retry-delay 5 \
            http://$ALB_DNS/health

            echo "üì® Sending test payload..."
            curl --fail --retry 5 --retry-delay 5 \
            -X POST http://$ALB_DNS/send \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ci-test" \
            -d '{
                "data": {
                "email_subject": "CI Smoke Test",
                "email_sender": "github-actions",
                "email_timestream": "1690000000",
                "email_content": "hello from pipeline"
                }
            }'

            echo "‚úÖ ALB smoke test passed"
